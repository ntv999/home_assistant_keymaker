# nRF52840 Gate Controller Home Assistant Integration

Интеграция Home Assistant для управления воротами через nRF52840 с BLE.

## Устройство

- **Прошивка**: nRF5 SDK 15.2.0 с BLE Mesh
- **Протокол связи**: BLE через Nordic UART Service (NUS)
- **Команды**: JSON через BLE NUS

## Возможности

- ✅ Управление воротами (открыть/закрыть/остановить)
- ✅ Мониторинг состояния ворот в реальном времени
- ✅ Автоматическое переподключение
- ✅ Поддержка нескольких устройств

## Установка

### 1. Подготовка прошивки

1. Скомпилируйте и загрузите обновленную прошивку на устройство nRF52840
2. Убедитесь, что устройство рекламирует Nordic UART Service (NUS)

### 2. Установка интеграции

#### Способ 1: HACS (рекомендуется)

1. Установите [HACS](https://hacs.xyz/) если еще не установлен
2. Добавьте этот репозиторий как custom repository
3. Установите интеграцию через HACS

#### Способ 2: Ручная установка

1. Скопируйте папку `nrf_gate_controller` в директорию `custom_components` вашего Home Assistant.

   **Путь зависит от типа установки Home Assistant:**
   
   - **Home Assistant OS / Supervised:**
     ```
     /config/custom_components/nrf_gate_controller/
     ```
   
   - **Home Assistant Container (Docker):**
     ```
     <путь_к_volume_конфигурации>/custom_components/nrf_gate_controller/
     ```
     Например: `/home/user/homeassistant/custom_components/nrf_gate_controller/`
   
   - **Home Assistant Core (Python venv):**
     ```
     ~/.homeassistant/custom_components/nrf_gate_controller/
     ```
     или
     ```
     <путь_к_конфигурации>/custom_components/nrf_gate_controller/
     ```

   **Важно:** Если директория `custom_components` не существует, создайте её вручную.

2. Убедитесь, что структура файлов следующая:
   ```
   custom_components/
   └── nrf_gate_controller/
       ├── __init__.py
       ├── manifest.json
       ├── ble_client.py
       ├── config_flow.py
       ├── const.py
       ├── coordinator.py
       └── cover.py
   ```

3. Перезапустите Home Assistant

### 3. Настройка

1. Перейдите в **Настройки** → **Устройства и службы**
2. Нажмите **Добавить интеграцию**
3. Найдите **NRF Gate Controller**
4. Выберите метод подключения:
   - **Автоматическое сканирование** (рекомендуется) - интеграция автоматически найдет устройства с Nordic UART Service
   - **Ввести MAC-адрес вручную** - если автоматическое сканирование не работает

#### Автоматическое сканирование

1. Выберите **Автоматическое сканирование**
2. Дождитесь завершения сканирования (около 10 секунд)
3. Если устройство не найдено:
   - Убедитесь, что устройство включено и находится в зоне действия BLE
   - **Нажмите кнопку на устройстве 2 раза быстро** (двойной клик) для очистки BLE bonding данных и подготовки к новому подключению
   - Повторите сканирование
4. Выберите найденное устройство из списка
5. Введите имя устройства (опционально, по умолчанию "Gate Controller")
6. Нажмите **Отправить**
7. Выберите **Working Mode** (режим работы устройства):
   - **PP (Импульсный)** - режим с импульсным управлением
   - **Open/Close (Старт/Стоп)** - режим старт/стоп
   - **Door (Дверь)** - режим для двери
   - **SCA** - режим SCA
   - **SCA Open** - режим SCA Open
   - **SCA Motion** - режим SCA Motion
8. Нажмите **Отправить** для завершения настройки

#### Ручной ввод MAC-адреса

1. Выберите **Ввести MAC-адрес вручную**
2. Введите MAC-адрес устройства (например: `AA:BB:CC:DD:EE:FF`)
3. Введите имя устройства (опционально)
4. Нажмите **Отправить**
5. Выберите **Working Mode** (режим работы устройства) - см. описание выше
6. Нажмите **Отправить** для завершения настройки

#### Этапы подключения

**Важно:** Если устройство уже было подключено к другому устройству или возникают проблемы с подключением:

1. **Подготовка устройства:**
   - Убедитесь, что устройство включено
   - **Нажмите кнопку на устройстве 2 раза быстро** (двойной клик) для очистки всех сохраненных BLE ключей
   - Устройство готово к новому подключению

2. **Сканирование:**
   - Запустите автоматическое сканирование в Home Assistant
   - Устройство должно быть обнаружено по UUID сервиса Nordic UART Service (`6e400001-b5a3-f393-e0a9-e50e24dcca9e`)

3. **Подключение:**
   - Выберите устройство из списка найденных
   - Выберите Working Mode (режим работы устройства)
   - Интеграция автоматически подключится к устройству, установит выбранный режим работы и создаст cover entity

**Важно:** Working Mode определяет, как устройство интерпретирует состояния открытия/закрытия ворот. Выберите режим, соответствующий типу ваших ворот и способу их управления.

**Примечание:** Двойной клик кнопки очищает все BLE bonding данные. Это необходимо делать только при первом подключении или при проблемах с подключением.

## Использование

После настройки вы увидите cover entity с именем вашего устройства. Вы можете:

- **Открыть** ворота
- **Закрыть** ворота  
- **Остановить** ворота
- Видеть текущее состояние (открыто/закрыто/открывается/закрывается)

## Состояния ворот

- `0` = OPENED (полностью открыто)
- `1` = OPEN (открывается)
- `2` = STOP_MIDDLE (остановлено)
- `3` = CLOSE (закрывается)
- `4` = CLOSED (полностью закрыто)

## Команды

Интеграция отправляет следующие команды через BLE:

- `{"cmd": 1}` - Открыть
- `{"cmd": 3}` - Закрыть
- `{"cmd": 2}` - Остановить
- `{"cmd": 17}` - Получить состояние

## Требования

- Home Assistant 2023.1 или новее
- BLE адаптер (встроенный в Raspberry Pi 5 или USB адаптер)
- Python библиотека `bleak` >= 0.21.0

## Устранение неполадок

### Устройство не подключается

1. Убедитесь, что устройство включено и рекламирует BLE
2. Проверьте MAC-адрес устройства
3. Убедитесь, что Home Assistant имеет доступ к BLE
4. Проверьте логи Home Assistant на наличие ошибок

### Команды не работают

1. Проверьте, что прошивка обновлена с поддержкой JSON команд через NUS
2. Убедитесь, что устройство принимает команды (проверьте логи устройства)
3. Проверьте, что BLE соединение активно

### Устройство отключается

1. Проверьте расстояние до устройства (BLE имеет ограниченную дальность)
2. Убедитесь, что нет помех
3. Проверьте батарею устройства (если применимо)

## Разработка

### Структура проекта

```
nrf_gate_controller/
├── __init__.py          # Инициализация интеграции
├── manifest.json        # Метаданные интеграции
├── config_flow.py       # Конфигурация через UI
├── const.py            # Константы
├── ble_client.py       # BLE клиент для связи с устройством
├── coordinator.py      # Координатор обновлений данных
└── cover.py            # Cover платформа
```

### Протокол связи

Интеграция использует Nordic UART Service (NUS) для связи:

- **Service UUID**: `6e400001-b5a3-f393-e0a9-e50e24dcca9e`
- **RX Characteristic** (запись): `6e400002-b5a3-f393-e0a9-e50e24dcca9e`
- **TX Characteristic** (уведомления): `6e400003-b5a3-f393-e0a9-e50e24dcca9e`

Команды отправляются в формате JSON:
```json
{"cmd": 1}*\n
```

Ответы приходят в формате JSON:
```json
{"state": 0, "mode": 4}*\n
```

## Лицензия

MIT License

## Поддержка

При возникновении проблем создайте issue в репозитории проекта.
